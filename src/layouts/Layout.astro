---
import { SEO } from 'astro-seo'
import MainPageIconButton from '../components/MainPageIconButton.astro'
import CommandPalette from '../components/CommandPalette.astro'
import CommandPaletteButton from '../components/CommandPaletteButton.astro'
import Il from '../components/InnerLink.astro'
import PostHog from '../components/posthog.astro'

export interface Props {
  title?: string
  desc?: string
  type?: string
  coverImage?: string
}

const { title, desc, type, coverImage } = Astro.props

// Generate OG image URL
const currentPath = Astro.url.pathname
const contentId = currentPath.split('/').filter(Boolean).join('/')

// Use localhost URL in development, production URL otherwise
const baseUrl = import.meta.env.DEV ? 'http://localhost:4321' : Astro.site

// Construct OG image URL - now just using the content ID directly
const ogImageURL = type ? new URL(`/og/${contentId}.png`, baseUrl) : new URL(`/og.png`, baseUrl)

// Only add search params for non-content pages (like the homepage)
if (!type) {
  if (title) ogImageURL.searchParams.set('title', title)
  if (desc) ogImageURL.searchParams.set('description', desc)
  if (coverImage) ogImageURL.searchParams.set('coverImage', coverImage)
}

// Google Analytics type declarations
declare global {
  interface Window {
    dataLayer: any[]
    gtag: (...args: any[]) => void
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <link rel="stylesheet" href="/preflight.css" />
    <link rel="stylesheet" href="/style.css" />
    <script type="module" src="https://js.withorbit.com/orbit-web-component.js"></script>
    <!-- Privacy-friendly analytics by Plausible -->
    <script async src="https://plausible.io/js/pa-ZRVBiABYnlryH-8eiXH29.js"></script>
    <script>
      ;((window.plausible =
        window.plausible ||
        function () {
          ;(plausible.q = plausible.q || []).push(arguments)
        }),
        (plausible.init =
          plausible.init ||
          function (i) {
            plausible.o = i || {}
          }))
      plausible.init()
    </script>
    <SEO
      title={title}
      description={desc ||
        "Beat's digital garden with notes and essays on Software Engineering, and other written thinking"}
      openGraph={{
        basic: {
          type: 'website',
          url: Astro.url.href,
          title: title || 'Beat Hagenlocher',
          image: ogImageURL.toString(),
        },
      }}
    />
    <PostHog />
  </head><body
    class="font-sans font-normal f-text-sm bg-zinc-800 text-zinc-300 leading-[1.6] antialiased selection:bg-sienna-light selection:text-zinc-800 max-w-screen-xl mx-auto scroll-smooth"
  >
    <CommandPalette placeholder="Search commands and content..." />
    <div class="flex f-my-xl justify-center items-center gap-4">
      <MainPageIconButton classStyle="f-w-128-164" />
      <CommandPaletteButton />
    </div>
    <main class="f-mb-md min-h-screen">
      <slot />
    </main>
    <footer class="my-12 flex justify-center text-center">
      <span class="font-light font-sans f-text-xs text-zinc-400 italic">
        Thought of something you want to share with me? <br />
        Please <Il href="contacting-me">tell me about it</Il> :)
      </span>
    </footer>
  </body>
</html>

<script>
  import { registerCommands } from '../store/commandPalette.ts'

  registerCommands([
    {
      id: 'home',
      name: 'Go Home',
      description: 'Navigate to homepage',
      handler: () => (window.location.href = '/'),
      keywords: ['navigate', 'index'],
    },
    {
      id: 'stream',
      name: 'Stream',
      description: 'Watch the stream flow',
      handler: () => (window.location.href = '/stream'),
      keywords: ['navigate', 'index'],
    },
    {
      id: 'me',
      name: 'About',
      description: 'Navigate to my About page',
      handler: () => (window.location.href = '/me'),
      keywords: ['navigate', 'index'],
    },
  ])
</script>
