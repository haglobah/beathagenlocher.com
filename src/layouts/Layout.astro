---
import { SEO } from 'astro-seo'
import MainPageIconButton from '../components/MainPageIconButton.astro'
import CommandPalette from '../components/CommandPalette.astro'
import CommandPaletteButton from '../components/CommandPaletteButton.astro'
import Il from '../components/InnerLink.astro'

export interface Props {
  title?: string
  desc?: string
  type?: string
  coverImage?: string
}

const { title, desc, type, coverImage } = Astro.props

// Generate OG image URL
const currentPath = Astro.url.pathname
const contentId = currentPath.split('/').filter(Boolean).join('/')

// Use localhost URL in development, production URL otherwise
const baseUrl = import.meta.env.DEV ? 'http://localhost:4321' : Astro.site

// Construct OG image URL - now just using the content ID directly
const ogImageURL = type ? new URL(`/og/${contentId}.png`, baseUrl) : new URL(`/og.png`, baseUrl)

// Only add search params for non-content pages (like the homepage)
if (!type) {
  if (title) ogImageURL.searchParams.set('title', title)
  if (desc) ogImageURL.searchParams.set('description', desc)
  if (coverImage) ogImageURL.searchParams.set('coverImage', coverImage)
}

// Google Analytics type declarations
declare global {
  interface Window {
    dataLayer: any[]
    gtag: (...args: any[]) => void
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Beat Hagenlocher's RSS Feed"
      href="/rss.xml"
    />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <link rel="stylesheet" href="/preflight.css" />
    <link rel="stylesheet" href="/style.css" />
    <script type="module" src="https://js.withorbit.com/orbit-web-component.js"></script>
    <!-- Privacy-friendly analytics by Umami -->
    <script
      defer
      src="https://cloud.umami.is/script.js"
      data-website-id="7fe00dc9-cc97-4277-a8d8-5db47e9c3408"></script>
    <SEO
      title={title}
      description={desc ||
        "Beat's digital garden with notes and essays on Software Engineering, and other written thinking"}
      openGraph={{
        basic: {
          type: 'website',
          url: Astro.url.href,
          title: title || 'Beat Hagenlocher',
          image: ogImageURL.toString(),
        },
      }}
    />
    <!-- Posthog -->
    <script>
      !(function (t, e) {
        var o, n, p, r
        e.__SV ||
          (window.posthog && window.posthog.__loaded) ||
          ((window.posthog = e),
          (e._i = []),
          (e.init = function (i, s, a) {
            function g(t, e) {
              var o = e.split('.')
              ;(2 == o.length && ((t = t[o[0]]), (e = o[1])),
                (t[e] = function () {
                  t.push([e].concat(Array.prototype.slice.call(arguments, 0)))
                }))
            }
            ;(((p = t.createElement('script')).type = 'text/javascript'),
              (p.crossOrigin = 'anonymous'),
              (p.async = !0),
              (p.src =
                s.api_host.replace('.i.posthog.com', '-assets.i.posthog.com') + '/static/array.js'),
              (r = t.getElementsByTagName('script')[0]).parentNode.insertBefore(p, r))
            var u = e
            for (
              void 0 !== a ? (u = e[a] = []) : (a = 'posthog'),
                u.people = u.people || [],
                u.toString = function (t) {
                  var e = 'posthog'
                  return ('posthog' !== a && (e += '.' + a), t || (e += ' (stub)'), e)
                },
                u.people.toString = function () {
                  return u.toString(1) + '.people (stub)'
                },
                o =
                  'init Rr Mr fi Or Ar ci Tr Cr capture Mi calculateEventProperties Lr register register_once register_for_session unregister unregister_for_session Hr getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty Ur jr createPersonProfile zr kr Br opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing Dr debug M Nr getPageViewId captureTraceFeedback captureTraceMetric $r'.split(
                    ' ',
                  ),
                n = 0;
              n < o.length;
              n++
            )
              g(u, o[n])
            e._i.push([i, s, a])
          }),
          (e.__SV = 1))
      })(document, window.posthog || [])
      posthog.init('phc_XkJSBO9H7tdhZvJ9HGNKSLDZdOsdM909pBJ6EUfrPdB', {
        api_host: 'https://a.beathagenlocher.com',
        ui_host: 'https://eu.i.posthog.com',
        defaults: '2025-05-24',
        person_profiles: 'identified_only', // or 'always' to create profiles for anonymous users as well
      })
    </script>
  </head>
  <body
    class="font-sans font-normal f-text-sm bg-zinc-800 text-zinc-300 leading-[1.6] antialiased selection:bg-sienna-light selection:text-zinc-800 max-w-screen-xl mx-auto scroll-smooth"
  >
    <CommandPalette placeholder="Search commands and content..." />
    <div class="flex f-my-xl justify-center items-center gap-6">
      <MainPageIconButton class="f-w-128-164 -m-6" />
      <CommandPaletteButton />
      <div class="flex items-center bg-zinc-700 rounded-full">
        <a
          href="/me"
          title="About"
          class="px-3 py-2 hover:bg-zinc-600 text-zinc-300 rounded-l-full transition-colors f-text-xs font-medium"
        >
          About
        </a>
        <span class="w-px h-5 bg-zinc-500"></span>
        <a
          href="/rss.xml"
          title="RSS Feed"
          class="p-2 hover:bg-zinc-600 text-zinc-300 rounded-r-full transition-colors flex items-center"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
          </svg>
        </a>
      </div>
    </div>
    <main class="f-mb-md min-h-screen">
      <slot />
    </main>
    <footer class="my-12 flex justify-center text-center">
      <span class="font-light font-sans f-text-xs text-zinc-400 italic">
        Thought of something you want to share with me? <br />
        Please <Il href="contacting-me">tell me about it</Il> :)
      </span>
    </footer>
  </body>
</html>

<script>
  import { registerCommands } from '../store/commandPalette.ts'

  registerCommands([
    {
      id: 'home',
      name: 'Go Home',
      description: 'Navigate to homepage',
      handler: () => (window.location.href = '/'),
      keywords: ['navigate', 'index'],
    },
    {
      id: 'stream',
      name: 'Stream',
      description: 'Watch the stream flow',
      handler: () => (window.location.href = '/stream'),
      keywords: ['navigate', 'index'],
    },
    {
      id: 'me',
      name: 'About',
      description: 'Navigate to my About page',
      handler: () => (window.location.href = '/me'),
      keywords: ['navigate', 'index'],
    },
    {
      id: 'contact',
      name: 'Contact Me',
      description: 'Navigate to my Contact page',
      handler: () => (window.location.href = '/contacting-me'),
      keywords: ['navigate', 'index'],
    },
  ])
</script>
