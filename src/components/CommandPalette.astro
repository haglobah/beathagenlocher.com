---
import { $commandItems } from '../store/commandPalette'

export interface Props {
  placeholder?: string
}

const { placeholder = 'Search commands...' } = Astro.props
---

<div id="command-palette" class="hidden fixed inset-0 top-[20%] z-50 justify-center p-4">
  <div class="fixed inset-0 bg-black bg-opacity-50" id="palette-backdrop"></div>
  <div class="relative bg-zinc-900 rounded-lg shadow-xl w-full max-w-5xl flex flex-col">
    <div id="topic-selector" class="hidden rounded-t-lg bg-zinc-950">
      <div class="text-xs pt-4 px-4 text-zinc-500 uppercase mb-2">
        Select Topic (<span class="font-mono text-cornflower bg-zinc-900">TAB</span>, <span
          class="i-heroicons:arrow-up-20-solid text-cornflower inline-block size-[1.2em]"></span>, <span
          class="i-heroicons:arrow-down-20-solid text-cornflower inline-block size-[1.2em]"></span>)
      </div>
      <div id="topic-selector-items" class="flex flex-wrap p-4 gap-2 max-h-32 overflow-y-auto">
      </div>
    </div>
    <div class="flex flex-1 min-h-0">
      <div class="flex-1 flex flex-col min-w-0">
        <div class="px-4 py-2 f-text-xs font-light">
          Type <span class="f-text-sm font-medium text-cornflower">#</span> to select from topics
        </div>
        <input
          type="text"
          id="palette-input"
          class="w-full px-4 py-3 bg-transparent text-zinc-100 placeholder:text-zinc-500 placeholder:f-text-xs outline-none"
          placeholder={placeholder}
          autocomplete="off"
        />
        <div id="palette-results" class="max-h-96 overflow-y-auto"></div>
      </div>
      <div id="palette-preview" class="hidden md:block w-96 p-4 overflow-y-auto bg-zinc-950">
        <div id="preview-content" class="text-sm text-zinc-400"></div>
      </div>
    </div>
  </div>
</div>

<script>
  import FlexSearch from 'flexsearch'
  import { initModel, update, type Model, type Msg, type Cmd } from '../store/commandPaletteModel'
  import { $commandItems, type CommandItem, type SearchResult } from '../store/commandPalette'

  // ============================================================================
  // DOM References
  // ============================================================================

  const palette = document.getElementById('command-palette')!
  const input = document.getElementById('palette-input') as HTMLInputElement
  const results = document.getElementById('palette-results')!
  const backdrop = document.getElementById('palette-backdrop')!
  const previewPane = document.getElementById('palette-preview')!
  const previewContent = document.getElementById('preview-content')!
  const topicSelector = document.getElementById('topic-selector')!
  const topicSelectorItems = document.getElementById('topic-selector-items')!

  // ============================================================================
  // Model & Dispatch Loop
  // ============================================================================

  let model = initModel()

  const dispatch = (msg: Msg) => {
    const [newModel, cmd] = update(msg, model)
    model = newModel
    render()
    performCmd(cmd)
  }

  // ============================================================================
  // View Rendering (Pure Projections)
  // ============================================================================

  const showPalette = () => {
    palette.classList.remove('hidden')
    palette.classList.add('flex')
  }

  const hidePalette = () => {
    palette.classList.add('hidden')
    palette.classList.remove('flex')
  }

  const hidePreview = () => previewPane.classList.remove('md:block')
  const showPreview = () => previewPane.classList.add('md:block')

  const renderTopicSelector = () => {
    if (model.filteredTopics.length === 0) {
      topicSelectorItems.innerHTML = '<div class="text-zinc-500 text-sm">No topics found</div>'
      return
    }

    topicSelectorItems.innerHTML = model.filteredTopics
      .map((topic, index) => {
        const isSelected = index === model.selectedTopicIndex
        const count = model.topicCounts.get(topic) || 0
        return `
          <div
            class="f-text-xs cursor-pointer transition-all"
            data-topic-index="${index}"
          >
            <span class="flex rounded-full px-[0.9em] py-[0.5em] font-medium leading-5 ${
              isSelected
                ? 'bg-sienna-mid/30 text-white hover:bg-sienna-mid/40 shadow-[0_0_12px_rgba(119,158,203,0.5)]'
                : 'bg-sienna-mid/10 text-sienna-mid hover:bg-sienna-mid/20'
            }">
              ${topic}
              <span class="ml-2 text-zinc-500">${count}</span>
            </span>
          </div>
        `
      })
      .join('')

    topicSelectorItems.querySelectorAll('[data-topic-index]').forEach((el) => {
      el.addEventListener('click', () => {
        const index = parseInt((el as HTMLElement).dataset.topicIndex!)
        dispatch({ kind: 'SelectTopic', topic: model.filteredTopics[index] })
      })
    })
  }

  const isSearchResult = (item: CommandItem | SearchResult): item is SearchResult => {
    return 'url' in item && 'type' in item
  }

  const highlightMatches = (text: string, query: string): string => {
    if (!query) return text
    const terms = query.toLowerCase().split(/\s+/).filter(Boolean)
    let result = text
    terms.forEach((term) => {
      const regex = new RegExp(`(${term})`, 'gi')
      result = result.replace(regex, '<mark class="bg-sienna-light text-zinc-800">$1</mark>')
    })
    return result
  }

  const getContextSnippet = (text: string, query: string): string => {
    if (!query) return text.slice(0, 300) + '...'
    const terms = query.toLowerCase().split(/\s+/).filter(Boolean)
    const lowerText = text.toLowerCase()
    let bestIndex = -1
    let bestScore = 0
    for (let i = 0; i < lowerText.length; i++) {
      let score = 0
      terms.forEach((term) => {
        if (lowerText.slice(i, i + 100).includes(term)) {
          score++
        }
      })
      if (score > bestScore) {
        bestScore = score
        bestIndex = i
      }
    }
    if (bestIndex === -1) {
      return text.slice(0, 300) + '...'
    }
    const start = Math.max(0, bestIndex - 50)
    const end = Math.min(text.length, bestIndex + 250)
    const snippet = text.slice(start, end)
    return (start > 0 ? '...' : '') + snippet + (end < text.length ? '...' : '')
  }

  const updatePreview = (item: CommandItem | SearchResult) => {
    if (isSearchResult(item)) {
      const snippet = getContextSnippet(item.body, model.query)
      const highlighted = highlightMatches(snippet, model.query)

      const topicBadges =
        item.topics && item.topics.length > 0
          ? `<div class="flex flex-wrap gap-2 mt-3">
            ${item.topics
              .map((t) => {
                const queryTerms = model.query.toLowerCase().split(/\s+/).filter(Boolean)
                const isMatch = queryTerms.some((term) => t.toLowerCase().includes(term))
                const bgClass = isMatch ? 'bg-sienna-mid/30' : 'bg-sienna-mid/10'
                const textClass = isMatch ? 'text-white' : 'text-sienna-mid'
                return `
                <div class="f-text-xs">
                  <span class="flex rounded-full ${bgClass} px-[0.9em] py-[0.5em] font-medium leading-5 ${textClass}">
                    ${t}
                  </span>
                </div>
              `
              })
              .join('')}
           </div>`
          : ''

      previewContent.innerHTML = `
        <div class="mb-4">
          <div class="text-xs text-zinc-500 uppercase mb-1">${item.type}</div>
          <div class="text-lg font-medium text-zinc-100 mb-2">${item.title}</div>
          ${item.description ? `<div class="text-sm text-zinc-400 mb-3">${item.description}</div>` : ''}
          ${topicBadges}
        </div>
        <div class="text-zinc-300 leading-relaxed whitespace-pre-wrap">${highlighted}</div>
      `
      showPreview()
    } else {
      previewContent.innerHTML = `
        <div class="mb-4">
          <div class="text-lg font-medium text-zinc-100 mb-2">${item.name}</div>
          ${item.description ? `<div class="text-sm text-zinc-400">${item.description}</div>` : ''}
        </div>
        ${item.keywords ? `<div class="text-xs text-zinc-500 mt-4">Keywords: ${item.keywords.join(', ')}</div>` : ''}
      `
      showPreview()
    }
  }

  const renderResults = () => {
    // Guard: if indices aren't built yet, show a loading state
    if (!model.commandIndex && !model.contentIndex) {
      results.innerHTML = '<div class="px-4 py-8 text-center text-zinc-500">Loading search index...</div>'
      hidePreview()
      return
    }

    if (model.filteredItems.length === 0) {
      results.innerHTML = '<div class="px-4 py-8 text-center text-zinc-500">No results found</div>'
      hidePreview()
      return
    }

    results.innerHTML = model.filteredItems
      .map((item, index) => {
        const isSelected = index === model.selectedIndex

        if (isSearchResult(item)) {
          return `
            <div
              class="px-4 py-3 cursor-pointer transition-colors ${
                isSelected ? 'bg-zinc-800 text-zinc-100' : 'text-zinc-300 hover:bg-zinc-800'
              }"
              data-index="${index}"
            >
              <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-0.5 rounded bg-zinc-700 text-zinc-400">${item.type}</span>
                <div class="font-medium">${item.title}</div>
              </div>
              ${item.description ? `<div class="text-sm text-zinc-500 mt-1">${item.description}</div>` : ''}
            </div>
          `
        } else {
          return `
            <div
              class="px-4 py-3 cursor-pointer transition-colors ${
                isSelected ? 'bg-zinc-800 text-zinc-100' : 'text-zinc-300 hover:bg-zinc-800'
              }"
              data-index="${index}"
            >
              <div class="font-medium">${item.name}</div>
              ${item.description ? `<div class="text-sm text-zinc-500">${item.description}</div>` : ''}
            </div>
          `
        }
      })
      .join('')

    results.querySelectorAll('[data-index]').forEach((el) => {
      el.addEventListener('click', () => {
        const index = parseInt((el as HTMLElement).dataset.index!)
        dispatch({ kind: 'Execute', item: model.filteredItems[index] })
      })
    })

    if (model.filteredItems[model.selectedIndex]) {
      updatePreview(model.filteredItems[model.selectedIndex])
    }
  }

  const render = () => {
    if (!model.isOpen) {
      hidePalette()
      return
    }

    showPalette()

    // Sync input value from model (only if not currently focused to avoid disrupting typing)
    if (document.activeElement !== input) {
      input.value = model.query
    }

    if (model.isTopicMode) {
      topicSelector.classList.remove('hidden')
      renderTopicSelector()
      results.innerHTML = ''
      hidePreview()
    } else {
      topicSelector.classList.add('hidden')
      renderResults()
    }
  }

  // ============================================================================
  // Command Interpreter (Impure Boundary)
  // ============================================================================

  const performCmd = (cmd: Cmd) => {
    switch (cmd.kind) {
      case 'None':
        break

      case 'LoadSearchIndex': {
        fetch('/api/search-index.json')
          .then((response) => response.json())
          .then((searchIndex) => {
            const topicsMap = new Map<string, number>()
            searchIndex.forEach((item: SearchResult) => {
              if (item.topics) {
                item.topics.forEach((topic) => {
                  topicsMap.set(topic, (topicsMap.get(topic) || 0) + 1)
                })
              }
            })

            dispatch({ kind: 'SearchIndexLoaded', index: searchIndex, topics: topicsMap })
          })
          .catch((error) => {
            console.error('Failed to load search index:', error)
          })
        break
      }

      case 'BuildCommandIndex': {
        const commandIndex = new FlexSearch.Index({
          tokenize: 'forward',
          cache: true,
        })

        cmd.commands.forEach((cmd, idx) => {
          const searchableText = `${cmd.name} ${cmd.description || ''} ${cmd.keywords?.join(' ') || ''}`
          commandIndex.add(idx, searchableText)
        })

        dispatch({ kind: 'CommandIndexReady', index: commandIndex })
        break
      }

      case 'BuildContentIndex': {
        const contentIndex = new FlexSearch.Index({
          tokenize: 'forward',
          cache: true,
          context: {
            resolution: 9,
            depth: 2,
            bidirectional: true,
          },
        })

        cmd.searchIndex.forEach((item, idx) => {
          const topicsText = item.topics ? item.topics.join(' ') : ''
          const searchableText = `${item.title} ${item.description} ${topicsText} ${item.body}`
          contentIndex.add(idx, searchableText)
        })

        dispatch({ kind: 'ContentIndexReady', index: contentIndex, searchIndex: cmd.searchIndex })
        break
      }

      case 'Navigate': {
        window.location.href = cmd.url
        break
      }

      case 'ExecuteHandler': {
        cmd.handler()
        break
      }

      case 'UpdateQueryParams': {
        const params = new URLSearchParams(window.location.search)
        if (cmd.query) {
          params.set('q', cmd.query)
        } else {
          params.delete('q')
        }
        window.history.replaceState({}, '', `${window.location.pathname}?${params}`)
        break
      }

      case 'FocusInput': {
        input.focus()
        break
      }

      case 'ScrollIntoView': {
        const element =
          document.querySelector(`[data-topic-index="${cmd.index}"]`) ||
          document.querySelector(`[data-index="${cmd.index}"]`)
        if (element) {
          element.scrollIntoView({ behavior: 'instant', block: 'nearest' })
        }
        break
      }
    }
  }

  // ============================================================================
  // Event Listeners
  // ============================================================================

  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault()
      dispatch(model.isOpen ? { kind: 'Close' } : { kind: 'Open' })
      return
    }

    if (!model.isOpen) return

    dispatch({ kind: 'KeyDown', key: e.key, shiftKey: e.shiftKey })
  })

  input.addEventListener('input', (e) => {
    const newValue = (e.target as HTMLInputElement).value
    console.log(newValue)
    dispatch({ kind: 'QueryChanged', query: newValue })
  })

  backdrop.addEventListener('click', () => {
    dispatch({ kind: 'Close' })
  })

  // ============================================================================
  // Initialization
  // ============================================================================

  const initializeFromParams = () => {
    // Build command index first, before opening the palette
    const commands = $commandItems.get()
    dispatch({ kind: 'BuildCommandIndex', commands })

    const params = new URLSearchParams(window.location.search)
    const queryFromParams = params.get('q') || ''

    if (queryFromParams) {
      dispatch({ kind: 'Open' })
      dispatch({ kind: 'QueryChanged', query: queryFromParams })
    }
  }

  initializeFromParams()
</script>
